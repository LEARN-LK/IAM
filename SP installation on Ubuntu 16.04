Based on the guides by https://github.com/ConsortiumGARR/idem-tutorials
Install software requirements
1.	Become ROOT and update
o	sudo su -
o	apt update && apt upgrade
2.	Install the packages required:
o	apt install ca-certificates vim openssl
Configure the environment
1.	Modify your /etc/hosts:
o	vim /etc/hosts
127.0.1.1 sp.example.org sp
2.	(Replace sp.example.org with your SP Full Qualified Domain Name)
3.	Be sure that your firewall doesn't block the traffic on port 443 (or you can't access to your SP)
4.	Define the costant APACHE_LOG, SHIB_SP and SHIBD_LOG inside /etc/environment:
o	vim /etc/environment
o	APACHE_LOG=/var/log/apache2
o	SHIB_SP=/etc/shibboleth
SHIBD_LOG=/var/log/shibboleth
o	source /etc/environment
(OPTIONAL) Create a Certificate and a Key self-signed for HTTPS if you don't have yet the official ones provided by the Certificate Authority(DigicertCA):
o	openssl req -x509 -newkey rsa:4096 -keyout /etc/ssl/private/ssl-sp.key -out /etc/ssl/certs/ssl-sp.crt -nodes -days 1095
Install Shibboleth Service Provider
1.	Become ROOT:
o	sudo su -
2.	Install Shibboleth SP:
o	apt install apache2 libapache2-mod-shib2 libapache2-mod-php ntp
From this point the location of the SP directory is: /etc/shibboleth
Configuration Instructions
Configure SSL on Apache2
1.	Modify the file /etc/apache2/sites-available/default-ssl.conf as follows:
2.	<IfModule mod_ssl.c>
3.	   SSLStaplingCache        shmcb:/var/run/ocsp(128000)
4.	   <VirtualHost _default_:443>
5.	     ServerName sp.example.org:443
6.	     ServerAdmin admin@example.org
7.	     DocumentRoot /var/www/html
8.	     ...
9.	     SSLEngine On
10.	     
11.	     SSLProtocol All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
12.	     SSLCipherSuite "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH"
13.	
14.	     SSLHonorCipherOrder on
15.	
16.	     # Disable SSL Compression
17.	     SSLCompression Off
18.	     
19.	     # OCSP Stapling, only in httpd/apache >= 2.3.3
20.	     SSLUseStapling          on
21.	     SSLStaplingResponderTimeout 5
22.	     SSLStaplingReturnResponderErrors off
23.	     
24.	     # Enable HTTP Strict Transport Security with a 2 year duration
25.	     Header always set Strict-Transport-Security "max-age=63072000;includeSubDomains;preload"
26.	     ...
27.	     SSLCertificateFile /etc/ssl/certs/ssl-sp.crt
28.	     SSLCertificateKeyFile /etc/ssl/private/ssl-sp.key
29.	     SSLCertificateChainFile /root/certificates/ssl-ca.pem
30.	     ...
31.	   </VirtualHost>
</IfModule>
32.	Enable proxy_http, SSL and headers Apache2 modules:
o	a2enmod proxy_http ssl headers alias include negotiation
o	a2ensite default-ssl.conf
o	systemctl restart apache2
33.	Configure Apache2 to open port 80 only for localhost:
o	vim /etc/apache2/ports.conf
o	# If you just change the port or add more ports here, you will likely also
o	# have to change the VirtualHost statement in
o	# /etc/apache2/sites-enabled/000-default.conf
o	
o	Listen 127.0.0.1:80
o	
o	<IfModule ssl_module>
o	  Listen 443
o	</IfModule>
o	
o	<IfModule mod_gnutls.c>
o	  Listen 443
</IfModule>
34.	Configure Apache2 to redirect all on HTTPS:
o	vim /etc/apache2/sites-enabled/000-default.conf
o	<VirtualHost *:80>
o	   ServerName "sp.example.org"
o	   Redirect permanent "/" "https://sp.example.org/"
o	   RedirectMatch permanent ^/(.*)$ https://sp.example.org/$1
</VirtualHost>
Configure Shibboleth SP
1.	Become ROOT:
o	sudo su -
2.	Download Federation Metadata Signing Certificate:
o	cd /etc/shibboleth/
o	wget https://www.idem.garr.it/documenti/doc_download/321-idem-metadata-signer-2019 -O idem_signer.pem
o	Check the validity:
	openssl x509 -in idem_signer.pem -fingerprint -sha1 -noout
(sha1: 2F:F8:24:78:6A:A9:2D:91:29:19:2F:7B:33:33:FF:59:45:C1:7C:C8)
	openssl x509 -in federation-cert.pem -fingerprint -md5 -noout
(md5: AA:A7:CD:41:2D:3E:B7:F6:02:8A:D3:62:CD:21:F7:DE)
3.	Edit shibboleth2.xml opportunely:
o	vim /etc/shibboleth/shibboleth2.xml
o	...
o	<ApplicationDefaults entityID="https://sp.example.org/shibboleth"
o	     REMOTE_USER="eppn persistent-id targeted-id">
o	...
o	<Sessions lifetime="28800" timeout="3600" checkAddress="false" handlerSSL="true" cookieProps="https">
o	...
o	<SSO discoveryProtocol="SAMLDS" discoveryURL="https://wayf.idem-test.garr.it/WAYF">
o	   SAML2
o	</SSO>
o	...
o	<MetadataProvider type="XML" uri="http://www.garr.it/idem-metadata/idem-test-metadata-sha256.xml" legacyOrgName="true" backingFilePath="idem-test-metadata-sha256.xml" reloadInterval="600">
o	      <MetadataFilter type="Signature" certificate="idem_signer.pem"/>
o	      <MetadataFilter type="RequireValidUntil" maxValidityInterval="864000" />
</MetadataProvider>
4.	Create SP metadata credentials:
o	/usr/sbin/shib-keygen
o	shibd -t /etc/shibboleth/shibboleth2.xml (Check Shibboleth configuration)
5.	Enable Shibboleth Apache2 configuration:
o	a2enmod shib2
o	systemctl reload apache2.service
6.	Now you are able to reach your Shibboleth SP Metadata on:
o	https://sp.example.org/Shibboleth.sso/Metadata (change sp.example.org to you SP full qualified domain name)
7.	Register you SP on IDEM Entity Registry (your entity have to be approved by an IDEM Federation Operator before become part of IDEM Test Federation):
o	Go to https://registry.idem.garr.it/ and follow "Insert a New Service Provider into the IDEM Test Federation"
Configure an example federated resouce "secure"
1.	Create the Apache2 configuration for the application:
o	sudo su -
o	vim /etc/apache2/site-available/secure.conf
o	RedirectMatch    ^/$  /secure
o	
o	<Location /secure>
o	  Authtype shibboleth
o	  ShibRequireSession On
o	  require valid-user
</Location>
2.	Create the "secure" application into the DocumentRoot:
o	mkdir /var/www/html/secure
o	vim /var/www/html/secure/index.php
o	<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
o	<html>
o	  <head>
o	    <title></title>
o	    <meta name="GENERATOR" content="Quanta Plus">
o	    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
o	  </head>
o	  <body>
o	    <p>
o	     <a href="https://sp.example.org/privacy.html">Privacy Policy</a>
o	    </p>
o	    <?php
o	    // Visualizza tutte le informazioni, default: INFO_ALL
o	    //phpinfo();
o	    foreach ($_SERVER as $key => $value){
o	       print $key." = ".$value."<br>";
o	    }
o	    /*foreach ($_ENV as $key => $value){
o	       print $key." = ".$value."<br>";
o	    }
o	    foreach ($_COOKIE as $key => $value){
o	       print $key." = ".$value."<br>";
o	    }*/
o	    ?>
o	  </body>
</html>
3.	Install needed packages:
o	apt istall libapache2-mod-php
o	systemctl restart apache2.service
